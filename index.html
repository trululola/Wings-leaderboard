<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leaderboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="screen">
  <div class="overlay">
    <!-- header está oculto por CSS (tu imagen ya tiene título) -->
    <div class="header">
      <div class="title">TOP SPENDERS</div>
      <div class="subtitle">Semana actual</div>
    </div>

    <div id="board" class="board"></div>

    <div class="footer">
      Última actualización: <span id="ts">—</span>
    </div>
  </div>
</div>

<script>
// Link CSV (debe terminar en output=csv). Ya lo pegaste; confirmalo entre comillas:
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzNtqv5w4-BVu15h4JH4O1MLKD4LuSRlAVFDvKtpk-jccCeWlcIn7y9_2d9wQhFN1if8RUkjflG-RY/pub?output=csv";

// Intervalo y filas a mostrar
const REFRESH_MS = 5000;
const MAX_ROWS = 10;

// parse CSV robusto (maneja comillas simples y comas dentro de campos)
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/).filter(l=>l.trim()!=='');
  if(lines.length === 0) return [];
  const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h=>h.trim().replace(/^"|"$/g,''));
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.trim().replace(/^"|"$/g,''));
    const obj = {};
    for(let j=0;j<headers.length;j++){
      obj[headers[j] || `col${j}`] = cols[j] ? cols[j] : "";
    }
    rows.push(obj);
  }
  return rows;
}

// convertir valores tipo "320.000" o "₩320,000" a número entero
function normalizeNumber(s){
  if(s === undefined || s === null) return 0;
  let cleaned = String(s).replace(/\s/g,'');
  // quitar símbolos comunes de moneda y separadores
  cleaned = cleaned.replace(/₩|\$|€|,|\./g,'');
  cleaned = cleaned.replace(/[^\d-]/g,'');
  const n = parseInt(cleaned,10);
  return isNaN(n) ? 0 : n;
}

// ordenar y generar ranks (empates comparten el mismo rank)
function computeRankedRows(rows){
  const mapped = rows.map(r=>{
    const name = r.Name ?? r.name ?? r.NOMBRE ?? Object.values(r)[0] ?? "";
    const scoreRaw = (r.Score ?? r.score ?? Object.values(r)[1] ?? "");
    return {
      raw: r,
      name: String(name).trim(),
      scoreRaw: String(scoreRaw).trim(),
      score: normalizeNumber(scoreRaw)
    };
  });

  mapped.sort((a,b)=>{
    if(b.score !== a.score) return b.score - a.score;
    return a.name.localeCompare(b.name, undefined, {sensitivity:'base'});
  });

  let lastScore = null;
  let lastRank = 0;
  for(let i=0;i<mapped.length;i++){
    if(mapped[i].score !== lastScore){
      lastRank = i + 1;
      lastScore = mapped[i].score;
    }
    mapped[i].rank = lastRank;
  }
  return mapped;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}
function formatNumber(n){
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function renderBoard(mapped){
  const board = document.getElementById("board");
  board.innerHTML = "";
  const top = mapped.slice(0, MAX_ROWS);

  if(top.length === 0){
    board.innerHTML = '<div class="row"><div class="error">No hay datos. Añade nombres y scores en la hoja "DATA".</div></div>';
    return;
  }

  top.forEach((item, idx)=>{
    const row = document.createElement("div");
    row.className = "row" + (idx===0 ? " top1" : "");
    row.innerHTML = `
      <div class="rank">${item.rank}</div>
      <div class="name">${escapeHtml(item.name)}</div>
      <div class="score">₩${formatNumber(item.score)}</div>
    `;
    board.appendChild(row);
  });

  document.getElementById("ts").textContent = new Date().toLocaleTimeString();
}

async function loadAndRender(){
  // Si no cambiaste el texto, mostramos la instrucción
  if(!SHEET_CSV || SHEET_CSV.includes("TU_LINK_CSV_AQUI")){
    document.getElementById('board').innerHTML = '<div class="row"><div class="error">Pega tu link CSV publicado del Google Sheet (Archivo → Publicar en la web → CSV) en la variable SHEET_CSV.</div></div>';
    return;
  }

  try{
    const res = await fetch(SHEET_CSV, {cache: "no-store"});
    if(!res.ok) throw new Error("No se pudo cargar la hoja. Asegúrate de publicar como CSV.");
    const text = await res.text();
    const rows = parseCSV(text);
    const mapped = computeRankedRows(rows);
    renderBoard(mapped);
  }catch(err){
    console.error(err);
    document.getElementById('board').innerHTML = `<div class="row"><div class="error">Error cargando hoja. Revisa el link CSV y que esté publicado.</div></div>`;
  }
}

loadAndRender();
setInterval(loadAndRender, REFRESH_MS);
</script>
</body>
</html>